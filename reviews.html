<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Street Food Website - Reviews</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

</head>
<body class="bg-orange-30">

  <!-- Unified Navbar from first code -->
  <nav>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="dishes.html">Dishes</a></li>
      <li><a href="featured.html">Featured</a></li>
      <li><a href="location.html">Locations</a></li>
      <li><a href="about.html">About Us</a></li>
      <li><a href="faq.html">FAQ</a></li>
      <li><a href="events.html">Events</a></li>
      <li><a class="active" href="reviews.html">Reviews</a></li>
      <li><a href="contact.html">Contact</a></li>
    </ul>
    
  </nav>

  <!-- Reviews Page -->
  <main class="pt-10 p-4">
    <div id="allReviewsPage" class="max-w-6xl mx-auto">
      <h2 class="text-xl font-bold mb-4">All Reviews</h2>
      <div id="reviewsContainer" class="space-y-4 flex flex-col items-center"></div>
    </div>

    <!-- Floating Create Review Button -->
    <a id="fab" href="#/create" title="Create a review"
      class="group fixed bottom-6 right-6 flex items-center justify-center rounded-full bg-orange-500 text-white shadow-xl transition-all duration-300 overflow-hidden"
      onclick="showCreatePage(true)">
      <!-- Pencil Icon -->
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
        class="w-6 h-6 m-4 flex-shrink-0 transition-transform duration-300 group-hover:scale-110">
        <path d="M21.731 2.269a2.625 2.625 0 0 0-3.714 0l-1.157 1.157 
                3.714 3.714 1.157-1.157a2.625 2.625 0 0 0 0-3.714z"/>
        <path d="M3 17.25V21h3.75l11.03-11.03-3.75-3.75L3 17.25z"/>
      </svg>
      <!-- Expanding Label -->
      <span class="whitespace-nowrap opacity-0 max-w-0 group-hover:opacity-100 group-hover:max-w-xs transition-all duration-300 pr-4 font-medium">
        Create a new review
      </span>
    </a>

    <!-- Create/Edit Form -->
    <div id="createReviewPage" class="hidden pt-10 p-4 max-w-6xl mx-auto">
      <h2 class="text-xl font-bold mb-4">Create/Edit Review</h2>
      <form id="reviewForm" class="space-y-4">
        <input type="text" id="userName" placeholder="Your Name" class="w-full border p-2 rounded" required />
        <input type="text" id="restaurantName" placeholder="Restaurant/Stall Name" class="w-full border p-2 rounded" required />
        <input type="text" id="foodName" placeholder="e.g., Nasi Lemak, Roti Canai" class="w-full border p-2 rounded" required />
        <textarea id="fullAddress" placeholder="Full Address" class="w-full border p-2 rounded" required></textarea>
        <button type="button" onclick="getLocation()" class="bg-blue-500 text-white px-4 py-2 rounded">Use My Location</button>
        <div id="map"></div>
        <textarea id="comment" placeholder="Write a comment..." class="w-full border p-2 rounded"></textarea>
        <div id="starRating" class="flex gap-1">
          <span class="star gray" data-value="1">★</span>
          <span class="star gray" data-value="2">★</span>
          <span class="star gray" data-value="3">★</span>
          <span class="star gray" data-value="4">★</span>
          <span class="star gray" data-value="5">★</span>
        </div>
        <input type="file" id="mediaUpload" multiple accept="image/*,video/*" class="w-full" />
        <div id="mediaPreview" class="media-preview"></div>
        <p id="mediaCounter" class="text-sm text-gray-600 mt-1"></p>
        <p id="mediaLimitWarning" class="text-red-600 text-sm mt-1 hidden">Media limit reached: Max 5 images, 2 videos</p>
        <button onclick="showAllReviews()" class="mt-4 bg-orange-500 text-white px-4 py-2 rounded" type="button">⬅ Back to Reviews</button>
        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Submit Review</button>
        <p id="createdDateDisplay" class="text-sm text-gray-400"></p>
        <p id="updatedDateDisplay" class="text-sm text-gray-600 italic"></p>
      </form>
    </div>
  </main>

  <!-- Lightbox Overlay -->
  <div id="lightboxOverlay">
    <button class="closeBtn">✖</button>
    <button class="arrow left">◀</button>
    <div id="lightboxContent"></div>
    <button class="arrow right">▶</button>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
  let selectedRating = 0, userMarker = null, currentSessionMedia = [], db;
  let isEditing = false;
  const mediaCounter = document.getElementById('mediaCounter');
  const mediaLimitWarning = document.getElementById('mediaLimitWarning');

  function updateMediaCounter(){
    const imgCount = currentSessionMedia.filter(m => m.type.startsWith('image')).length;
    const vidCount = currentSessionMedia.filter(m => m.type.startsWith('video')).length;
    mediaCounter.textContent = `${imgCount}/5 images uploaded, ${vidCount}/2 videos uploaded`;
  }

  function formatDate(date){
    if(!date) return '';
    const d = new Date(date);
    return d.toLocaleString();
  }

  const request = indexedDB.open("FoodReviewsDB", 1);
  request.onupgradeneeded = e => { 
    db = e.target.result; 
    if(!db.objectStoreNames.contains("reviews")) 
      db.createObjectStore("reviews", { keyPath: "id", autoIncrement: true }); 
  };
  request.onsuccess = e => { db = e.target.result; loadReviews(); };
  request.onerror = e => { console.error("IndexedDB error:", e); };

  function initStars() {
    document.querySelectorAll('#starRating .star').forEach(star=>{
      star.addEventListener('click', ()=>{ 
        selectedRating = parseInt(star.dataset.value); 
        updateStarDisplay(selectedRating); 
      });
      star.addEventListener('mouseover', ()=>{ if(!isEditing) updateStarDisplay(parseInt(star.dataset.value)); });
      star.addEventListener('mouseout', ()=>{ if(!isEditing) updateStarDisplay(selectedRating); });
    });
  }
  function updateStarDisplay(r){ 
    document.querySelectorAll('#starRating .star').forEach(star=>{
      star.classList.toggle('orange', parseInt(star.dataset.value)<=r); 
      star.classList.toggle('gray', parseInt(star.dataset.value)>r); 
    }); 
  }

  function showCreatePage(isNew=true){
    if(isNew) isEditing = false;
    document.getElementById('allReviewsPage').classList.add('hidden');
    document.getElementById('createReviewPage').classList.remove('hidden');
    if(isNew){
      document.getElementById('reviewForm').reset();
      selectedRating=0; updateStarDisplay(0);
      currentSessionMedia=[]; renderMediaPreview();
      document.getElementById('reviewForm').onsubmit = originalFormSubmit;
      document.getElementById('createdDateDisplay').textContent='';
      document.getElementById('updatedDateDisplay').textContent='';
    }
    setTimeout(()=>{ map.invalidateSize(); if(userMarker) map.setView(userMarker.getLatLng(),16); },100);
  }
  function showAllReviews(){ document.getElementById('createReviewPage').classList.add('hidden'); document.getElementById('allReviewsPage').classList.remove('hidden'); }
  window.showCreatePage = showCreatePage; window.showAllReviews = showAllReviews;

  const mediaUpload = document.getElementById('mediaUpload');
  function renderMediaPreview(){
    const preview = document.getElementById('mediaPreview');
    preview.innerHTML='';
    currentSessionMedia.forEach((f,index)=>{
      const wrapper=document.createElement('div'); 
      wrapper.className='media-wrapper relative'; 
      wrapper.draggable=true; 
      wrapper.dataset.index=index;

      const element = f.type.startsWith('image') ? document.createElement('img') : document.createElement('video');
      if(f.type.startsWith('video')){ element.src = f.url; element.muted = true; element.autoplay = true; element.loop = true; element.playsInline = true; element.controls = false; } 
      else { element.src = f.url; }
      element.style.objectFit = 'cover';
      element.style.width = '100%';
      element.style.height = '100px';
      element.style.cursor = 'pointer';

      const removeBtn=document.createElement('button'); 
      removeBtn.textContent='✖';
      removeBtn.className='absolute top-0 right-0 bg-white text-red-600 px-1 rounded-full shadow';
      removeBtn.onclick=()=>{ currentSessionMedia.splice(index,1); renderMediaPreview(); updateMediaCounter(); };

      const dragHandle=document.createElement('div');
      dragHandle.textContent='⇅';
      dragHandle.className='absolute bottom-0 left-0 bg-gray-600 text-white px-1 rounded-t mr-1 cursor-move';
      dragHandle.style.userSelect='none';

      wrapper.appendChild(element); 
      wrapper.appendChild(removeBtn); 
      wrapper.appendChild(dragHandle);

      wrapper.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', index); wrapper.classList.add('dragging'); });
      wrapper.addEventListener('dragover', e=>{ e.preventDefault(); });
      wrapper.addEventListener('drop', e=>{
        e.preventDefault();
        const draggedIndex = e.dataTransfer.getData('text/plain');
        const targetIndex = wrapper.dataset.index;
        if(draggedIndex==targetIndex) return;
        const temp = currentSessionMedia[draggedIndex];
        currentSessionMedia[draggedIndex] = currentSessionMedia[targetIndex];
        currentSessionMedia[targetIndex] = temp;
        renderMediaPreview();
        updateMediaCounter();
      });
      wrapper.addEventListener('dragend', ()=>{ wrapper.classList.remove('dragging'); });

      preview.appendChild(wrapper);
    });
    updateMediaCounter();
    enableLightboxGallery();
  }

  if(mediaUpload){
    mediaUpload.addEventListener('change', function(){
      const files = Array.from(this.files);
      files.forEach(file=>{
        const imgCount = currentSessionMedia.filter(m=>m.type.startsWith('image')).length;
        const vidCount = currentSessionMedia.filter(m=>m.type.startsWith('video')).length;
        if(file.type.startsWith('image') && imgCount>=5){ mediaLimitWarning.classList.remove('hidden'); return; }
        if(file.type.startsWith('video') && vidCount>=2){ mediaLimitWarning.classList.remove('hidden'); return; }
        mediaLimitWarning.classList.add('hidden');
        const reader=new FileReader();
        reader.onload=e=>{
          currentSessionMedia.push({url:e.target.result,type:file.type});
          renderMediaPreview();
        };
        reader.readAsDataURL(file);
      });
    });
  }

  function originalFormSubmit(e){
    e.preventDefault();
    const userName=document.getElementById('userName').value.trim();
    const restaurantName=document.getElementById('restaurantName').value.trim();
    const foodName=document.getElementById('foodName').value.trim();
    const fullAddress=document.getElementById('fullAddress').value.trim();
    const comment=document.getElementById('comment').value.trim();
    if(!userName||!restaurantName||!foodName||!fullAddress){ alert("Please fill in all required fields!"); return; }
    if(selectedRating===0){ alert("Please select a star rating!"); return; }
    if(currentSessionMedia.length===0){ alert("Please upload at least 1 image or video!"); return; }

    const now = new Date();
    const transaction = db.transaction(["reviews"], "readwrite");
    const store = transaction.objectStore("reviews");
    store.add({ userName, restaurantName, foodName, fullAddress, comment, rating:selectedRating, media:currentSessionMedia, createdDate: now, updatedDate: now });
    transaction.oncomplete=()=>{ showCreatePage(true); showAllReviews(); loadReviews(); };
    transaction.onerror=e=>{ console.error(e); alert("Failed to save review"); };
  }
  document.getElementById('reviewForm').onsubmit=originalFormSubmit;

  function handleEditReview(r){
    isEditing = true;
    document.getElementById('userName').value = r.userName;
    document.getElementById('restaurantName').value = r.restaurantName;
    document.getElementById('foodName').value = r.foodName;
    document.getElementById('fullAddress').value = r.fullAddress;
    document.getElementById('comment').value = r.comment;
    selectedRating = r.rating;
    currentSessionMedia = r.media || [];
    renderMediaPreview();
    updateStarDisplay(selectedRating);

    // Show timestamps
    document.getElementById('createdDateDisplay').textContent = `Created: ${formatDate(r.createdDate)}`;
    document.getElementById('updatedDateDisplay').textContent = r.updatedDate ? `Last Updated: ${formatDate(r.updatedDate)}` : '';

    showCreatePage(false);

    document.getElementById('reviewForm').onsubmit = function(e){
      e.preventDefault();
      const userName=document.getElementById('userName').value.trim();
      const restaurantName=document.getElementById('restaurantName').value.trim();
      const foodName=document.getElementById('foodName').value.trim();
      const fullAddress=document.getElementById('fullAddress').value.trim();
      const comment=document.getElementById('comment').value.trim();
      if(!userName||!restaurantName||!foodName||!fullAddress){ alert("Please fill in all required fields!"); return; }
      if(selectedRating===0){ alert("Please select a star rating!"); return; }
      if(currentSessionMedia.length===0){ alert("Please upload at least 1 image or video!"); return; }

      const now = new Date();
      const transaction=db.transaction(["reviews"],"readwrite");
      const store=db.transaction(["reviews"],"readwrite").objectStore("reviews");
      store.put({id:r.id, userName, restaurantName, foodName, fullAddress, comment, rating:selectedRating, media:currentSessionMedia, createdDate: r.createdDate, updatedDate: now});
      transaction.oncomplete=()=>{ showCreatePage(true); showAllReviews(); loadReviews(); document.getElementById('reviewForm').onsubmit=originalFormSubmit; isEditing=false; };
    };
  }

  function loadReviews(){
  const container=document.getElementById("reviewsContainer");
  container.innerHTML="";
  const transaction=db.transaction(["reviews"],"readonly");
  const store=transaction.objectStore("reviews");
  
  let hasReviews = false; // <-- track if we find reviews

  store.openCursor(null,"prev").onsuccess=function(e){
    const cursor=e.target.result;
    if(cursor){
      hasReviews = true;
      const r=cursor.value;
      let starsHTML=''; for(let j=1;j<=5;j++) starsHTML+=`<span class='star ${j<=r.rating?'orange':'gray'}'>★</span>`;
      let mediaHTML=''; if(r.media) r.media.forEach(f=>{ mediaHTML+=f.type.startsWith('image')?`<img src="${f.url}"/>`:`<video src="${f.url}"></video>`; });
      const div=document.createElement("div");
      div.className="bg-white p-4 rounded shadow w-full max-w-2xl";
      div.innerHTML=`
        <h3 class="font-bold">Restaurant/Stall Name: ${r.restaurantName}</h3>
        <h3 class="font-bold">Food Name: ${r.foodName}</h3>
        <p><strong>Username: ${r.userName}</strong> <br> Rated - ${starsHTML}</p>
        <p>Address: ${r.fullAddress}</p>
        ${r.comment?`<p><em>Comment:</em> ${r.comment}</p>`:''}
        ${r.createdDate?`<p class="text-sm text-gray-400">Created: ${formatDate(r.createdDate)}</p>`:''}
        ${r.updatedDate?`<p class="text-sm text-gray-600 italic">Last Updated: ${formatDate(r.updatedDate)}</p>`:''}
        <div class="media-preview">${mediaHTML}</div>
        <div class="flex gap-2 mt-2">
          <button class="edit-btn bg-yellow-400 text-white px-2 py-1 rounded">Edit</button>
          <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded">Delete</button>
        </div>
      `;
      container.appendChild(div);
      div.querySelector('.edit-btn').addEventListener('click', ()=>handleEditReview(r));
      div.querySelector('.delete-btn').addEventListener('click', ()=>{ if(confirm("Are you sure you want to delete this review?")){ const transaction=db.transaction(["reviews"],"readwrite"); const store=db.transaction(["reviews"],"readwrite").objectStore("reviews"); store.delete(r.id); transaction.oncomplete=loadReviews; }});
      cursor.continue();
    } else {
      if(!hasReviews){
        container.innerHTML = `<p class="text-gray-600 italic">No reviews have been created yet. Be the first to share your street food experience!</p>`;
      }
    }
  };
}


  // Map & Geolocation
  const map=L.map('map').setView([3.139,101.6869],6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
  L.Control.geocoder({defaultMarkGeocode:false}).on('markgeocode',function(e){ const c=e.geocode.center; if(userMarker) map.removeLayer(userMarker); userMarker=L.marker(c).addTo(map); map.setView(c,16); document.getElementById('fullAddress').value=e.geocode.name; }).addTo(map);

  window.getLocation=function(){
    const fullAddressInput=document.getElementById('fullAddress');
    if(!navigator.geolocation){ alert("Geolocation not supported."); return; }
    navigator.geolocation.getCurrentPosition(async pos=>{
      const lat=pos.coords.latitude; const lng=pos.coords.longitude;
      try{ const res=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`,{headers:{'Accept':'application/json'}}); const data=await res.json(); fullAddressInput.value=data.display_name||`${lat}, ${lng}`; if(userMarker) map.removeLayer(userMarker); userMarker=L.marker([lat,lng]).addTo(map).bindPopup('You are here').openPopup(); map.setView([lat,lng],16); }catch(err){ console.error(err); fullAddressInput.value=`${lat}, ${lng}`; }
    }, err=>{ alert("Unable to retrieve your location."); }, { enableHighAccuracy:true, timeout:10000 });
  }

  initStars();

  // Lightbox
  const lightboxOverlay=document.getElementById('lightboxOverlay');
  const lightboxContent=document.getElementById('lightboxContent');
  const closeBtn=lightboxOverlay.querySelector('.closeBtn');
  let currentMediaList=[], currentMediaIndex=0;

  function openLightbox(mediaList,index){
    currentMediaList = mediaList;
    currentMediaIndex = index;
    renderLightbox();
    lightboxOverlay.classList.add('active');
  }

  function renderLightbox(){
    lightboxContent.innerHTML='';
    const media = currentMediaList[currentMediaIndex];
    if(!media) return;
    if(media.type.startsWith('image')){
      const img=document.createElement('img'); img.src=media.url; lightboxContent.appendChild(img);
    } else if(media.type.startsWith('video')){
      const vid=document.createElement('video'); vid.src=media.url; vid.controls=true; vid.autoplay=true; vid.muted=false; lightboxContent.appendChild(vid);
    }
  }

  lightboxOverlay.querySelector('.arrow.left').onclick=()=>{ if(currentMediaIndex>0){ currentMediaIndex--; renderLightbox(); } };
  lightboxOverlay.querySelector('.arrow.right').onclick=()=>{ if(currentMediaIndex<currentMediaList.length-1){ currentMediaIndex++; renderLightbox(); } };
  closeBtn.onclick=()=>{ lightboxOverlay.classList.remove('active'); lightboxContent.innerHTML=''; };
  lightboxOverlay.onclick=(e)=>{ if(e.target===lightboxOverlay){ lightboxOverlay.classList.remove('active'); lightboxContent.innerHTML=''; } };
  document.addEventListener('keydown', e => { if(!lightboxOverlay.classList.contains('active')) return; if(e.key==='ArrowLeft'){ if(currentMediaIndex>0){ currentMediaIndex--; renderLightbox(); } } if(e.key==='ArrowRight'){ if(currentMediaIndex<currentMediaList.length-1){ currentMediaIndex++; renderLightbox(); } } if(e.key==='Escape'){ lightboxOverlay.classList.remove('active'); lightboxContent.innerHTML=''; } });

  let touchStartX=0, touchEndX=0;
  lightboxOverlay.addEventListener('touchstart', e=>{ touchStartX=e.changedTouches[0].screenX; });
  lightboxOverlay.addEventListener('touchend', e=>{ touchEndX=e.changedTouches[0].screenX; handleSwipe(); });
  function handleSwipe(){ const diff=touchEndX-touchStartX; if(Math.abs(diff)>50){ if(diff>0){ if(currentMediaIndex>0){ currentMediaIndex--; renderLightbox(); } } else{ if(currentMediaIndex<currentMediaList.length-1){ currentMediaIndex++; renderLightbox(); } } } }

  function enableLightboxGallery(){
    document.querySelectorAll('.media-preview').forEach(container=>{
      const mediaEls = Array.from(container.querySelectorAll('img, video'));
      mediaEls.forEach((el,index)=>{
        if(!el.dataset.lightboxBound){
          el.dataset.lightboxBound='true';
          el.onclick=()=>{
            const mediaList = mediaEls.map(me=>({url:me.src,type:me.tagName.toLowerCase()==='img'?'image':'video'}));
            openLightbox(mediaList,index);
          };
        }
      });
    });
  }

  enableLightboxGallery();
  const observerGallery=new MutationObserver(enableLightboxGallery);
  observerGallery.observe(document.body,{childList:true,subtree:true});

});
</script>

  <footer>
    <p>© 2025 Malaysian Street Food. All rights reserved.</p>
  </footer>
</body>
</html>
