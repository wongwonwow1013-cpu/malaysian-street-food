<!DOCTYPE html>
<html lang="en">
<head>
  <!--
    File: review.html  |  Street Food Website
    Purpose: Reviews only (API section removed)
    Tech: HTML5, CSS3, JS (ES6), jQuery 3.x, Bootstrap 5.x
    Storage: localStorage (reviews), sessionStorage (form draft), cookies (theme + consent)
    Media: <video> intro, <audio> ‚Äúsuccess chime‚Äù on save, image preview (FileReader)
    Limits: 100KB max image upload per review
    UX: Mobile-first layout, toasts/modals, lightbox for images, quick-search chips (removed)
    Accessibility: Labels/aria attributes, required fields, keyboard focus styles
  -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Street Food ‚Äî Reviews</title>
  <link rel="stylesheet" href="style.css">

  <!-- Bootstrap & jQuery (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    :root { --brand:#ff6b35; --accent:#ffd166; }
    body[data-theme="dark"] { background:#111; color:#f4f4f4; }
    .brand-gradient { background: linear-gradient(135deg, var(--brand), #f3722c); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .floating { animation: floatY 3s ease-in-out infinite; }
    @keyframes floatY { 0%, 100%{ transform: translateY(0) } 50%{ transform: translateY(-6px) } }
    .star { cursor: pointer; font-size: 1.25rem; color: #ccc; transition: transform .1s ease; }
    .star.active { color: #f5a623; transform: scale(1.1); }
    .review-card:hover { box-shadow: 0 10px 24px rgba(0,0,0,.12); transform: translateY(-2px); transition: .2s; }
    .thumb { width: 64px; height: 64px; object-fit: cover; border-radius: .5rem; cursor: zoom-in; }
    .pill { background: var(--accent); color: #222; border-radius: 999px; padding: .15rem .6rem; font-size: .8rem; }
    .required::after{ content:" *"; color:#dc3545 }
    .video-wrap { border-radius: 1rem; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,.15); }
    #cookieBar { position: fixed; bottom: 1rem; left: 1rem; right: 1rem; z-index: 1030; }
  </style>
</head>
<body>
  <!-- Cookie Consent + Theme via Cookies -->
  <div id="cookieBar" class="alert alert-dark d-none shadow-lg" role="alert" aria-live="polite">
    üç™ We use cookies to remember your theme and improve your experience.
    <button id="acceptCookies" class="btn btn-primary btn-sm ms-2">Accept</button>
    <button id="declineCookies" class="btn btn-outline-secondary btn-sm ms-1">Decline</button>
  </div>

  <!-- Navbar -->
  <nav class="msf-navbar" role="navigation" aria-label="Main">
    <ul class="msf-nav">
      <li><a href="index.html">Home</a></li>
      <li><a href="dishes.html">Dishes</a></li>
      <li><a href="featured.html">Featured</a></li>
      <li><a href="gallery.html">Gallery</a></li>
      <li><a href="location.html">Locations</a></li>
      <li><a class="active" href="reviews.html">Reviews</a></li>
      <li><a href="contact.html">Contact</a></li>
      <li><a href="about.html">About Us</a></li>
      <li><a href="faq.html">FAQ</a></li>
      <li><a href="events.html">Events</a></li>
    </ul>
  </nav>

  <style>
    /* --- top nav --- */
    .msf-navbar{
      position: fixed; top: 0; left: 0; right: 0;
      background: #f1872d;          /* orange bar */
      z-index: 1100;
      box-shadow: 0 1px 0 rgba(0,0,0,.08), 0 4px 12px rgba(0,0,0,.06);
    }
    .msf-nav{
      list-style: none;
      margin: 0; padding: .65rem 1.25rem;
      display: flex; gap: .25rem;
      justify-content: center; flex-wrap: wrap;
    }
    .msf-nav > li{ display: inline-flex; }
    .msf-nav a{
      display: block;
      text-decoration: none;
      color: #fff; font-weight: 600;
      padding: .45rem .9rem; line-height: 1;
      border-radius: .3rem;
    }
    .msf-nav a:hover, .msf-nav a:focus{
      background: rgba(255,255,255,.16);
      outline: none;
    }
    .msf-nav a.active{
      background: rgba(255,255,255,.28); /* highlighted tab */
    }
    /* keep page content below the fixed bar */
    body{ padding-top: 64px; }

    @media (max-width: 576px){
      .msf-nav{ overflow-x: auto; white-space: nowrap; }
    }
  </style>

  <!-- Header -->
  <header class="py-5 bg-light">
    <div class="container">
      <div class="row align-items-center g-4">
        <div class="col-lg-6">
          <h1 class="display-5 fw-bold">Share Your <span class="brand-gradient">Street Food</span> Experience</h1>
          <p class="lead mb-3">Rate stalls, upload a photo, and help others discover the best eats near you.</p>
          <div class="d-flex gap-2">
            <a href="#reviewForm" class="btn btn-primary">Write a Review</a>
            <!-- Keep two buttons for same layout; link to reviews instead of removed API section -->
            <a href="#reviews" class="btn btn-outline-secondary">Browse Reviews</a>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="video-wrap floating">
            <!-- Robust, auto-fallback video (sources injected by JS) -->
            <video id="heroVideo"
                   controls
                   playsinline
                   preload="metadata"
                   width="100%"
                   poster="https://images.unsplash.com/photo-1481833761820-0509d3217039?q=80&w=1200&auto=format&fit=crop"
                   crossorigin="anonymous"></video>
          </div>
          <div class="form-text text-center mt-2">Video: coverr.co (street food b-roll)</div>
        </div>
      </div>
    </div>
  </header>

  <!-- Review Form -->
  <main class="container my-5">
    <div class="row g-4">
      <section id="reviewForm" class="col-lg-5">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="h4 mb-3">Write a Review</h2>
            <form id="formReview" novalidate>
              <div class="mb-3">
                <label for="stallName" class="form-label required">Restaurant / Stall Name</label>
                <input id="stallName" class="form-control" required maxlength="60" placeholder="e.g., Ali Nasi Lemak">
                <div class="invalid-feedback">Please provide the restaurant/stall name.</div>
              </div>

              <div class="mb-3">
                <label for="foodName" class="form-label required">Food / Dish Name</label>
                <input id="foodName" class="form-control" required maxlength="60" placeholder="e.g., Nasi Lemak">
                <div class="invalid-feedback">Please provide the food or dish name.</div>
              </div>

              <div class="mb-3">
                <label for="location" class="form-label required">Location</label>
                <input id="location" class="form-control" required maxlength="80" placeholder="e.g., Jalan Alor, KL">
                <div class="invalid-feedback">Please provide a location.</div>
              </div>

              <div class="mb-3">
                <span class="form-label d-block required">Rating</span>
                <div id="rating" class="d-flex gap-1" role="radiogroup" aria-label="Star rating">
                  <span class="star" data-val="1" aria-label="1 star">‚òÖ</span>
                  <span class="star" data-val="2" aria-label="2 stars">‚òÖ</span>
                  <span class="star" data-val="3" aria-label="3 stars">‚òÖ</span>
                  <span class="star" data-val="4" aria-label="4 stars">‚òÖ</span>
                  <span class="star" data-val="5" aria-label="5 stars">‚òÖ</span>
                </div>
                <input type="hidden" id="ratingVal" value="0" required>
                <div class="form-text">Tap a star to rate.</div>
              </div>

              <div class="mb-3">
                <label for="reviewText" class="form-label required">Your Review</label>
                <textarea id="reviewText" class="form-control" rows="4" required maxlength="400" placeholder="Taste, price, queue time, hygiene, must-try items..."></textarea>
                <div class="invalid-feedback">Please write a short review.</div>
              </div>

              <div class="mb-3">
                <label for="photo" class="form-label">Media (Image, max 100KB)</label>
                <input id="photo" type="file" accept="image/*" class="form-control" data-max-bytes="102400">
                <div class="form-text">Maximum file size: <strong>100 KB</strong>. Larger files will be rejected.</div>
                <img id="preview" class="mt-2 d-none rounded" alt="preview" width="120" height="120" />
              </div>

              <div class="d-flex gap-2">
                <button class="btn btn-primary" type="submit">Save Review</button>
                <button class="btn btn-outline-secondary" id="btnClear" type="button">Clear</button>
              </div>
            </form>
            <audio id="chime" preload="auto">
              <source src="https://cdn.pixabay.com/audio/2022/03/15/audio_d3a3b1b5b4.mp3" type="audio/mpeg">
            </audio>
            <hr>
            <small class="text-muted">Data policy: Reviews are stored in your browser‚Äôs <strong>localStorage</strong>. Draft text is kept in <strong>sessionStorage</strong> until you submit.</small>
          </div>
        </div>
      </section>

      <!-- Reviews List -->
      <section class="col-lg-7">
        <div class="d-flex align-items-center justify-content-between">
          <h2 class="h4 mb-0">Recent Reviews</h2>
          <div class="btn-group">
            <button id="sortNewest" class="btn btn-sm btn-outline-secondary">Newest</button>
            <button id="sortRating" class="btn btn-sm btn-outline-secondary">Top Rated</button>
          </div>
        </div>
        <div id="reviews" class="mt-3 row g-3"></div>
      </section>
    </div>
  </main>

  <!-- FULL Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form id="formEditFull" class="modal-content" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Edit Review</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="editId">

          <div class="row g-3">
            <div class="col-md-6">
              <label for="editStall" class="form-label required">Restaurant / Stall Name</label>
              <input id="editStall" class="form-control" required maxlength="60">
              <div class="invalid-feedback">Please provide the restaurant/stall name.</div>
            </div>

            <div class="col-md-6">
              <label for="editFood" class="form-label required">Food / Dish Name</label>
              <input id="editFood" class="form-control" required maxlength="60">
              <div class="invalid-feedback">Please provide the food or dish name.</div>
            </div>

            <div class="col-12">
              <label for="editLoc" class="form-label required">Location</label>
              <input id="editLoc" class="form-control" required maxlength="80">
              <div class="invalid-feedback">Please provide a location.</div>
            </div>

            <div class="col-12">
              <span class="form-label d-block required">Rating</span>
              <div id="editRating" class="d-flex gap-1" role="radiogroup" aria-label="Star rating (edit)">
                <span class="star" data-val="1" aria-label="1 star">‚òÖ</span>
                <span class="star" data-val="2" aria-label="2 stars">‚òÖ</span>
                <span class="star" data-val="3" aria-label="3 stars">‚òÖ</span>
                <span class="star" data-val="4" aria-label="4 stars">‚òÖ</span>
                <span class="star" data-val="5" aria-label="5 stars">‚òÖ</span>
              </div>
              <input type="hidden" id="editRatingVal" value="0" required>
              <div class="form-text">Tap a star to rate.</div>
            </div>

            <div class="col-12">
              <label for="editText" class="form-label required">Your Review</label>
              <textarea id="editText" class="form-control" rows="4" required maxlength="400"></textarea>
              <div class="invalid-feedback">Please write a short review.</div>
            </div>

            <div class="col-12">
              <label for="editPhoto" class="form-label">Media (Image, max 100KB)</label>
              <input id="editPhoto" type="file" accept="image/*" class="form-control" data-max-bytes="102400">
              <div class="form-text">Maximum file size: <strong>100 KB</strong>.</div>
              <img id="editPreview" class="mt-2 d-none rounded" alt="preview" width="120" height="120" />
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
          <button class="btn btn-primary" type="submit">Save changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
    <div id="toastSaved" class="toast align-items-center text-bg-success border-0" role="status" aria-live="polite" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">Review saved successfully!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Image Viewer Modal -->
  <div class="modal fade" id="imgModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content border-0">
        <div class="modal-body p-0 text-center">
          <button type="button" class="btn-close position-absolute end-0 m-3" data-bs-dismiss="modal" aria-label="Close"></button>
          <img id="imgModalSrc" class="img-fluid rounded" alt="Review image">
          <div class="mt-2 mb-2">
            <a id="imgDownload" class="btn btn-sm btn-outline-secondary" href="#" download>Download</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="py-5 bg-light mt-5">
    <div class="container text-center">
      <p class="mb-2">Follow the #streetfood community:</p>
      <blockquote class="twitter-timeline" data-theme="light" data-height="380" data-dnt="true" data-chrome="noheader nofooter noborders transparent" href="https://twitter.com/hashtag/streetfood?src=hash">Tweets about #streetfood</blockquote>
      <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
      <p class="mt-3 small text-muted">¬© 2025 Street Food ‚Äî Built for UCCD2323 Front-End Web Development.</p>
    </div>
  </footer>

  <script>
  /* =========================
     Utilities: Cookies
     ========================= */
  function setCookie(name, value, days = 180) {
    const d = new Date();
    d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
    document.cookie = `${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/;SameSite=Lax`;
  }
  function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? decodeURIComponent(match[2]) : null;
  }

  $(function () {
    /* =========================
       Hero video auto-fallback (Coverr ‚Üí Pixabay ‚Üí MDN)
       ========================= */
    (function setupHeroVideo(){
      const SOURCES = [
        'https://cdn.coverr.co/videos/coverr-street-food-4842/1080p.mp4',
        'https://cdn.pixabay.com/video/2021/06/10/75160-560258677_large.mp4',
        'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4'
      ];
      const v = document.getElementById('heroVideo');
      let i = 0;
      function tryNext() {
        if (i >= SOURCES.length) return;
        v.src = SOURCES[i++];
        v.load();
      }
      v.addEventListener('error', tryNext, { passive: true });
      v.addEventListener('stalled', () => setTimeout(tryNext, 1200), { passive: true });
      tryNext();
    })();

    /* =========================
       Theme & Cookie Banner
       ========================= */
    const cookieBar = $('#cookieBar');
    const themeBtn = $('#toggleTheme');

    function applyTheme() {
      const theme = getCookie('theme') || 'light';
      document.body.dataset.theme = theme;
      themeBtn.text(theme === 'dark' ? '‚òÄÔ∏è Theme' : 'üåô Theme');
    }

    if (getCookie('consent') !== 'yes') cookieBar.removeClass('d-none');
    $('#acceptCookies').on('click', () => { setCookie('consent', 'yes'); cookieBar.addClass('d-none'); });
    $('#declineCookies').on('click', () => cookieBar.addClass('d-none'));
    applyTheme();
    themeBtn.on('click', () => {
      const current = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
      setCookie('theme', current);
      applyTheme();
    });

    /* =========================
       Helpers
       ========================= */
    const draftKeys = ['stallName', 'foodName', 'location', 'reviewText'];
    function clearValidation(formEl) {
      formEl.classList.remove('was-validated');
      formEl.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
        el.classList.remove('is-valid', 'is-invalid');
      });
    }

    /* =========================
       Rating stars (Create form)
       ========================= */
    $('#rating .star').on('mouseenter click', function () {
      const val = Number($(this).data('val'));
      $('#ratingVal').val(val);
      $('#rating .star').each(function () {
        $(this).toggleClass('active', Number($(this).data('val')) <= val);
      });
    });

    /* =========================
       Media preview (Create) with 100KB cap
       ========================= */
    $('#photo').on('change', function () {
      const file = this.files?.[0];
      const max = Number(this.dataset.maxBytes || '102400'); // 100 KB
      if (!file) { $('#preview').addClass('d-none').attr('src', ''); return; }
      if (file.size > max) {
        alert(`Selected file is ${Math.round(file.size / 1024)}KB. Max allowed is 100KB.`);
        this.value = '';
        $('#preview').addClass('d-none').attr('src', '');
        return;
      }
      const reader = new FileReader();
      reader.onload = e => { $('#preview').attr('src', e.target.result).removeClass('d-none'); };
      reader.readAsDataURL(file);
    });

    /* =========================
       Lightbox: click thumbnail to view full image
       ========================= */
    $('#reviews').on('click', '.thumb', function () {
      const src = $(this).attr('src');
      const alt = $(this).attr('alt') || 'Review image';
      $('#imgModalSrc').attr({ src, alt });
      const name = (alt || 'image').replace(/[^\w\-]+/g, '_') + '.jpg';
      $('#imgDownload').attr({ href: src, download: name });
      new bootstrap.Modal('#imgModal').show();
    });

    /* =========================
       Draft autosave (sessionStorage)
       ========================= */
    draftKeys.forEach(id => {
      const saved = sessionStorage.getItem('draft_' + id);
      if (saved) $('#' + id).val(saved);
      $('#' + id).on('input', function () { sessionStorage.setItem('draft_' + id, this.value); });
    });

    /* =========================
       Save Review -> localStorage
       ========================= */
    const toastSaved = new bootstrap.Toast('#toastSaved');

    $('#formReview').on('submit', function (e) {
      e.preventDefault();
      const form = this;

      form.classList.add('was-validated');
      if (!form.checkValidity() || Number($('#ratingVal').val()) === 0) {
        if (Number($('#ratingVal').val()) === 0) alert('Please select a rating.');
        return;
      }

      // Extra size check
      const fileInput = document.getElementById('photo');
      const f = fileInput.files?.[0];
      if (f && f.size > Number(fileInput.dataset.maxBytes || '102400')) {
        alert('Media exceeds 100KB limit. Please choose a smaller file.');
        return;
      }

      const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now());
      const review = {
        id,
        stall: $('#stallName').val().trim(),
        food: $('#foodName').val().trim(),
        loc: $('#location').val().trim(),
        rating: Number($('#ratingVal').val()),
        text: $('#reviewText').val().trim(),
        img: $('#preview').attr('src') || null,
        ts: Date.now()
      };

      const list = JSON.parse(localStorage.getItem('reviews') || '[]');
      list.push(review);
      localStorage.setItem('reviews', JSON.stringify(list));

      // Reset UI + clear drafts/validation
      draftKeys.forEach(k => sessionStorage.removeItem('draft_' + k));
      form.reset();
      $('#ratingVal').val(0);
      $('#preview').addClass('d-none').attr('src', '');
      $('#rating .star').removeClass('active');
      clearValidation(form);

      document.getElementById('chime')?.play().catch(() => { });
      toastSaved.show();
      renderReviews();
    });

    $('#btnClear').on('click', () => {
      const form = document.getElementById('formReview');
      form.reset();
      $('#ratingVal').val(0);
      $('#preview').addClass('d-none').attr('src', '');
      $('#rating .star').removeClass('active');
      clearValidation(form);
    });

    /* =========================
       Render Reviews
       ========================= */
    function renderReviews(sortBy = 'new') {
      const list = JSON.parse(localStorage.getItem('reviews') || '[]');
      list.sort((a, b) => sortBy === 'rating' ? b.rating - a.rating : b.ts - a.ts);
      const grid = $('#reviews').empty();
      if (!list.length) {
        grid.append(`<div class="col-12"><div class="alert alert-info">No reviews yet. Be the first!</div></div>`);
        return;
      }
      list.forEach(r => {
        const stars = '‚òÖ'.repeat(r.rating) + '‚òÜ'.repeat(5 - r.rating);
        grid.append(`
          <div class="col-12 col-md-6">
            <div class="card review-card h-100">
              <div class="card-body d-flex gap-3">
                <img class="thumb" src="${r.img || 'https://images.unsplash.com/photo-1526318472351-c75fcf070305?q=80&w=200&auto=format&fit=crop'}" alt="${r.stall} image">
                <div class="flex-grow-1">
                  <div class="d-flex align-items-start justify-content-between">
                    <div>
                      <h3 class="h6 mb-1">${r.stall}</h3>
                      <div class="text-muted small">${r.loc}</div>
                      <span class="badge rounded-pill text-bg-light mt-1">üçΩÔ∏è ${r.food || '‚Äî'}</span>
                    </div>
                    <span class="badge text-bg-warning">${stars}</span>
                  </div>
                  <p class="mt-2 mb-2">${r.text}</p>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" data-action="edit" data-id="${r.id}">Edit</button>
                    <button class="btn btn-sm btn-outline-danger" data-action="del" data-id="${r.id}">Delete</button>
                  </div>
                </div>
              </div>
            </div>
          </div>`);
      });
    }
    renderReviews();
    $('#sortNewest').on('click', () => renderReviews('new'));
    $('#sortRating').on('click', () => renderReviews('rating'));

    /* =========================
       Delete or Open Edit
       ========================= */
    let currentEditIndex = -1;

    $('#reviews').on('click', '[data-action]', function () {
      const id = $(this).data('id');
      const list = JSON.parse(localStorage.getItem('reviews') || '[]');
      const idx = list.findIndex(x => x.id === id);
      if (idx < 0) return;

      if ($(this).data('action') === 'del') {
        if (confirm('Delete this review?')) {
          list.splice(idx, 1);
          localStorage.setItem('reviews', JSON.stringify(list));
          renderReviews();
        }
      } else {
        // Open full edit modal
        currentEditIndex = idx;
        const r = list[idx];
        $('#editId').val(r.id);
        $('#editStall').val(r.stall);
        $('#editFood').val(r.food || '');
        $('#editLoc').val(r.loc);
        $('#editText').val(r.text);
        setEditStars(Number(r.rating) || 0);

        if (r.img) {
          $('#editPreview').attr('src', r.img).removeClass('d-none');
        } else {
          $('#editPreview').addClass('d-none').attr('src', '');
        }
        document.getElementById('editPhoto').value = '';
        clearValidation(document.getElementById('formEditFull'));
        new bootstrap.Modal('#editModal').show();
      }
    });

    /* =========================
       Edit: stars, media preview, save
       ========================= */
    function setEditStars(val) {
      $('#editRatingVal').val(val);
      $('#editRating .star').each(function () {
        $(this).toggleClass('active', Number($(this).data('val')) <= val);
      });
    }
    $('#editRating').on('mouseenter click', '.star', function () {
      setEditStars(Number($(this).data('val')));
    });

    $('#editPhoto').on('change', function () {
      const file = this.files?.[0];
      const max = Number(this.dataset.maxBytes || '102400');
      if (!file) { $('#editPreview').addClass('d-none').attr('src', ''); return; }
      if (file.size > max) {
        alert(`Selected file is ${Math.round(file.size / 1024)}KB. Max allowed is 100KB.`);
        this.value = '';
        $('#editPreview').addClass('d-none').attr('src', '');
        return;
      }
      const reader = new FileReader();
      reader.onload = e => { $('#editPreview').attr('src', e.target.result).removeClass('d-none'); };
      reader.readAsDataURL(file);
    });

    $('#formEditFull').on('submit', function (e) {
      e.preventDefault();
      const form = this;
      form.classList.add('was-validated');
      if (!form.checkValidity() || Number($('#editRatingVal').val()) === 0) {
        if (Number($('#editRatingVal').val()) === 0) alert('Please select a rating.');
        return;
      }

      const list = JSON.parse(localStorage.getItem('reviews') || '[]');
      if (currentEditIndex < 0 || currentEditIndex >= list.length) return;

      const fp = document.getElementById('editPhoto');
      const f = fp.files?.[0];
      if (f && f.size > Number(fp.dataset.maxBytes || '102400')) {
        alert('Media exceeds 100KB limit. Please choose a smaller file.');
        return;
      }

      const old = list[currentEditIndex];
      const updated = {
        ...old,
        stall: $('#editStall').val().trim(),
        food: $('#editFood').val().trim(),
        loc: $('#editLoc').val().trim(),
        rating: Number($('#editRatingVal').val()),
        text: $('#editText').val().trim(),
        img: (fp.files && fp.files.length) ? ($('#editPreview').attr('src') || null) : old.img
      };

      list[currentEditIndex] = updated;
      localStorage.setItem('reviews', JSON.stringify(list));
      renderReviews();

      bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
      clearValidation(form);
    });

    document.getElementById('editModal').addEventListener('hidden.bs.modal', () => {
      const ef = document.getElementById('formEditFull');
      ef.reset();
      $('#editPreview').addClass('d-none').attr('src', '');
      setEditStars(0);
      clearValidation(ef);
    });
  });
</script>

</body>
</html>
